(function(){"use strict";const E="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";function I(){return new Array(64).fill(null)}function v(t=E){const e=t.split(" ");if(e.length<4)throw new Error("Invalid FEN");const o=e[0].split("/"),n=I();for(let c=0;c<8;c++){const s=o[7-c];let b=0;for(const d of s)if(/\d/.test(d))b+=Number(d);else{const w=d===d.toUpperCase()?"w":"b",k=d.toLowerCase();n[c*8+b]={type:k,color:w},b++}}const a=e[1]==="w"?"w":"b",f={wks:!1,wqs:!1,bks:!1,bqs:!1};e[2].includes("K")&&(f.wks=!0),e[2].includes("Q")&&(f.wqs=!0),e[2].includes("k")&&(f.bks=!0),e[2].includes("q")&&(f.bqs=!0);const i=e[3]==="-"?null:F(e[3]),r=Number(e[4]||0),l=Number(e[5]||1);return{board:n,turn:a,castling:f,enPassant:i,halfmoveClock:r,fullmoveNumber:l,history:[]}}function F(t){const e="abcdefgh".indexOf(t[0]);return(Number(t[1])-1)*8+e}function p(t){return t>=0&&t<64}function u(t){return t%8}function h(t){return Math.floor(t/8)}function K(t){return{board:t.board.slice(),turn:t.turn,castling:{...t.castling},enPassant:t.enPassant,halfmoveClock:t.halfmoveClock,fullmoveNumber:t.fullmoveNumber,history:t.history.slice()}}function x(t){const e=[],o=t.turn;for(let n=0;n<64;n++){const a=t.board[n];if(!(!a||a.color!==o))switch(a.type){case"p":B(t,n,a,e);break;case"n":R(t,n,a,e);break;case"b":y(t,n,a,e,["ne","nw","se","sw"]);break;case"r":y(t,n,a,e,["n","s","e","w"]);break;case"q":y(t,n,a,e,["n","s","e","w","ne","nw","se","sw"]);break;case"k":D(t,n,a,e);break}}return e}function B(t,e,o,n){const a=o.color==="w"?8:-8,f=o.color==="w"?1:6,i=o.color==="w"?7:0,r=e+a;if(p(r)&&!t.board[r]){if(h(r)===i)["q","r","b","n"].forEach(c=>n.push({from:e,to:r,piece:o,promotion:c}));else if(n.push({from:e,to:r,piece:o}),h(e)===f){const c=e+2*a;p(c)&&!t.board[c]&&n.push({from:e,to:c,piece:o})}}const l=o.color==="w"?[7,9]:[-7,-9];for(const c of l){const s=e+c;if(!p(s))continue;const b=u(s)-u(e);if(Math.abs(b)!==1)continue;const d=t.board[s];if(d&&d.color!==o.color)h(s)===i?["q","r","b","n"].forEach(w=>n.push({from:e,to:s,piece:o,captured:d,promotion:w})):n.push({from:e,to:s,piece:o,captured:d});else if(t.enPassant!==null&&s===t.enPassant){const w=o.color==="w"?s-8:s+8,k=t.board[w];k&&k.type==="p"&&k.color!==o.color&&n.push({from:e,to:s,piece:o,captured:k,isEnPassant:!0})}}}function R(t,e,o,n){const a=[17,15,10,6,-6,-10,-15,-17];for(const f of a){const i=e+f;if(!p(i)||Math.abs(u(e)-u(i))>2)continue;const r=t.board[i];(!r||r.color!==o.color)&&n.push({from:e,to:i,piece:o,captured:r||null})}}function y(t,e,o,n,a){const f={n:8,s:-8,e:1,w:-1,ne:9,nw:7,se:-7,sw:-9};for(const i of a){const r=f[i];let l=e+r,c=u(e);for(;p(l);){const s=u(l);if(i==="e"||i==="w"){if(Math.abs(s-c)!==1)break}else if((i==="ne"||i==="nw"||i==="se"||i==="sw")&&Math.abs(s-c)!==1)break;const b=t.board[l];if(!b)n.push({from:e,to:l,piece:o});else{b.color!==o.color&&n.push({from:e,to:l,piece:o,captured:b});break}c=s,l+=r}}}function D(t,e,o,n){const a=[1,-1,8,-8,9,7,-7,-9];for(const f of a){const i=e+f;if(!p(i)||Math.abs(u(e)-u(i))>1)continue;const r=t.board[i];(!r||r.color!==o.color)&&n.push({from:e,to:i,piece:o,captured:r||null})}o.color==="w"?(t.castling.wks&&!t.board[5]&&!t.board[6]&&n.push({from:e,to:6,piece:o,isCastling:!0}),t.castling.wqs&&!t.board[1]&&!t.board[2]&&!t.board[3]&&n.push({from:e,to:2,piece:o,isCastling:!0})):(t.castling.bks&&!t.board[61]&&!t.board[62]&&n.push({from:e,to:62,piece:o,isCastling:!0}),t.castling.bqs&&!t.board[57]&&!t.board[58]&&!t.board[59]&&n.push({from:e,to:58,piece:o,isCastling:!0}))}function m(t,e){t.history.push({move:e,castling:{...t.castling},enPassant:t.enPassant,halfmoveClock:t.halfmoveClock});const{from:o,to:n,piece:a}=e;if(e.isEnPassant){const f=a.color==="w"?n-8:n+8;e.captured=t.board[f],t.board[f]=null}else e.captured=t.board[n];if(t.board[n]=e.promotion?{type:e.promotion,color:a.color}:a,t.board[o]=null,a.type==="k"&&(a.color==="w"?(t.castling.wks=!1,t.castling.wqs=!1):(t.castling.bks=!1,t.castling.bqs=!1),e.isCastling&&(n===6?(t.board[5]=t.board[7],t.board[7]=null):n===2?(t.board[3]=t.board[0],t.board[0]=null):n===62?(t.board[61]=t.board[63],t.board[63]=null):n===58&&(t.board[59]=t.board[56],t.board[56]=null))),a.type==="r"&&(o===0&&(t.castling.wqs=!1),o===7&&(t.castling.wks=!1),o===56&&(t.castling.bqs=!1),o===63&&(t.castling.bks=!1)),e.captured&&e.captured.type==="r"){const f=e.to;f===0&&(t.castling.wqs=!1),f===7&&(t.castling.wks=!1),f===56&&(t.castling.bqs=!1),f===63&&(t.castling.bks=!1)}t.enPassant=null,a.type==="p"&&Math.abs(e.to-e.from)===16&&(t.enPassant=(e.from+e.to)/2),a.type==="p"||e.captured?t.halfmoveClock=0:t.halfmoveClock++,t.turn==="b"&&t.fullmoveNumber++,t.turn=t.turn==="w"?"b":"w"}function C(t){const e=t.history.pop();if(!e)return;const{move:o,castling:n,enPassant:a,halfmoveClock:f}=e;if(t.turn=t.turn==="w"?"b":"w",t.turn==="b"&&t.fullmoveNumber--,t.board[o.from]=o.piece,o.isEnPassant){const i=o.piece.color==="w"?o.to-8:o.to+8;t.board[i]=o.captured||null,t.board[o.to]=null}else t.board[o.to]=o.captured||null;o.isCastling&&(o.to===6&&(t.board[7]=t.board[5],t.board[5]=null),o.to===2&&(t.board[0]=t.board[3],t.board[3]=null),o.to===62&&(t.board[63]=t.board[61],t.board[61]=null),o.to===58&&(t.board[56]=t.board[59],t.board[59]=null)),t.castling={...n},t.enPassant=a,t.halfmoveClock=f}function S(t,e,o){const n=o==="w"?[e-7,e-9]:[e+7,e+9];for(const r of n)if(p(r)&&Math.abs(u(e)-u(r))===1){const l=t.board[r];if(l&&l.type==="p"&&l.color===o)return!0}const a=[17,15,10,6,-6,-10,-15,-17];for(const r of a){const l=e+r;if(!p(l)||Math.abs(u(e)-u(l))>2)continue;const c=t.board[l];if(c&&c.type==="n"&&c.color===o)return!0}const f=[{d:8,type:"r"},{d:-8,type:"r"},{d:1,type:"r"},{d:-1,type:"r"},{d:9,type:"b"},{d:7,type:"b"},{d:-7,type:"b"},{d:-9,type:"b"}];for(const{d:r,type:l}of f){let c=e+r;for(;p(c);){const s=c-r,b=Math.abs(u(c)-u(s)),d=Math.abs(h(c)-h(s));if(b>1||d>1)break;const w=t.board[c];if(w){if(w.color===o&&(w.type===l||w.type==="q"))return!0;break}c+=r}}const i=[1,-1,8,-8,9,7,-7,-9];for(const r of i){const l=e+r;if(!p(l)||Math.abs(u(e)-u(l))>1)continue;const c=t.board[l];if(c&&c.type==="k"&&c.color===o)return!0}return!1}function L(t,e){for(let o=0;o<64;o++){const n=t.board[o];if(n&&n.type==="k"&&n.color===e)return o}return null}function N(t,e){const o=L(t,e);return o===null?!1:S(t,o,e==="w"?"b":"w")}function M(t){const e=x(t),o=[],n=t.turn==="w"?"b":"w";for(const a of e){if(a.isCastling){const i=a.to===6?[4,5,6]:a.to===2?[4,3,2]:a.to===62?[60,61,62]:[60,59,58];let r=!0;for(const l of i)if(S(t,l,n)){r=!1;break}if(!r)continue}const f=K(t);m(f,a),N(f,t.turn)||o.push(a)}return o}function O(t){const e=M(t),o=N(t,t.turn);return e.length===0?o?{check:!0,checkmate:!0,stalemate:!1,draw:!1}:{check:!1,checkmate:!1,stalemate:!0,draw:!0}:{check:o,checkmate:!1,stalemate:!1,draw:!1}}const Q={p:100,n:320,b:330,r:500,q:900,k:2e4};function V(t){let e=0;for(const o of t.board){if(!o)continue;const n=Q[o.type];e+=o.color==="w"?n:-n}return e}function P(t,e,o,n,a){const f=O(t);if(f.checkmate)return a?-1/0:1/0;if(f.stalemate||f.draw)return 0;if(e===0)return V(t);const i=M(t);if(i.sort((r,l)=>(l.captured?10:0)-(r.captured?10:0)),a){let r=-1/0;for(const l of i){m(t,l);const c=P(t,e-1,o,n,!1);if(C(t),r=Math.max(r,c),o=Math.max(o,c),n<=o)break}return r}else{let r=1/0;for(const l of i){m(t,l);const c=P(t,e-1,o,n,!0);if(C(t),r=Math.min(r,c),n=Math.min(n,c),n<=o)break}return r}}self.onmessage=t=>{const{fen:e,depth:o,color:n}=t.data,a=v(e),f=M(a);if(f.length===0){self.postMessage({bestMove:null});return}let i=null,r=n==="w"?-1/0:1/0;const l=n==="w";for(const c of f){const s=v(e);m(s,c);const b=P(s,o-1,-1/0,1/0,!l);l?b>r&&(r=b,i=c):b<r&&(r=b,i=c)}self.postMessage({bestMove:i})}})();
